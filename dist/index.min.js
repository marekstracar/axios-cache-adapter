!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("axios"),require("md5"),require("@tusbar/cache-control")):"function"==typeof define&&define.amd?define("index",["exports","axios","md5","@tusbar/cache-control"],t):t((e=e||self).index={},e.Axios,e.md5,e.cacheControl)}(this,(function(e,t,r,a){"use strict";function n(e){const t=typeof e;return null!=e&&("object"===t||"function"===t)}function c(e){return null===e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}function o(e){if(!n(e))return!1;const t=c(e);return"[object Function]"===t||"[object AsyncFunction]"===t||"[object GeneratorFunction]"===t||"[object Proxy]"===t}function s(e,t,r){if(r.data)try{r.data=JSON.parse(r.data)}catch(t){e.debug("Could not parse data as JSON",t)}const{request:a,config:n,...c}=r;return c}function u(e){if(o(e.key))return e.key;let t;return t=function(e){const t=typeof e;return"string"===t||"object"===t&&null!=e&&!Array.isArray(e)&&"[object String]"===c(e)}(e.key)?t=>{const a=`${t.baseURL?t.baseURL:""}${t.url}`,n=`${e.key}/${a}${d(t)}`;return t.data?n+r(t.data):n}:e=>{const t=`${e.baseURL?e.baseURL:""}${e.url}`+d(e);return e.data?t+r(e.data):t},t}async function i(e,t){const r=t.method.toLowerCase();e.exclude.methods.includes(r)&&await e.store.removeItem(e.uuid)}function d(e){if(!e.params)return"";if("undefined"==typeof URLSearchParams)return JSON.stringify(e.params);let t=e.params;return e.params instanceof URLSearchParams||(t=new URLSearchParams,Object.keys(e.params).forEach((r=>t.append(r,e.params[r])))),`?${t.toString()}`}async function l(e,t,r){const{request:n={},headers:c={}}=r;if(["arraybuffer","blob"].indexOf(n.responseType)>-1)return r;let o={};return e.readHeaders&&(c["cache-control"]?(o=a.parse(c["cache-control"]),(o.noCache||o.noStore)&&(e.excludeFromCache=!0)):c.expires?e.expires=new Date(c.expires).getTime():e.expires=(new Date).getTime()),e.excludeFromCache?r.request.excludedFromCache=!0:(o.maxAge||0===o.maxAge?e.expires=Date.now()+1e3*o.maxAge:e.readHeaders||(e.expires=0===e.maxAge?Date.now():Date.now()+e.maxAge),e.limit&&(e.debug(`Detected limit: ${e.limit}`),await async function(e){const t=await e.store.length();if(t<e.limit)return;let r;e.debug(`Current store size: ${t}`),await e.store.iterate(((e,t)=>{r||(r={value:e,key:t}),e.expires<r.value.expires&&(r={value:e,key:t})})),r&&(e.debug(`Removing item: ${r.key}`),await e.store.removeItem(r.key))}(e)),await async function(e,t,r){try{const t={expires:e.expires,data:s(e,0,r)};await e.store.setItem(e.uuid,t)}catch(t){if(e.debug("Could not store response",t),e.clearOnError)try{await e.store.clear()}catch(t){e.debug("Could not clear store",t)}return!1}return!0}(e,0,r)),r}async function f(e,t){e.debug("uuid",e.uuid);const r=(...r)=>l(e,t,...r);if(await e.invalidate(e,t),function(e={},t){const{exclude:r={},debug:a}=e,c=t.method.toLowerCase();if("head"===c||r.methods.includes(c))return a(`Excluding request by HTTP method ${t.url}`),!0;if("function"==typeof r.filter&&r.filter(t))return a(`Excluding request by filter ${t.url}`),!0;const o=/\?.*$/.test(t.url)||n(t.params)&&0!==Object.keys(t.params).length||"undefined"!=typeof URLSearchParams&&t.params instanceof URLSearchParams;return r.query&&o?(a(`Excluding request by query ${t.url}`),!0):!!(r.paths||[]).some((e=>t.url.match(e)))&&(a(`Excluding request by url match ${t.url}`),!0)}(e,t))return e.excludeFromCache=!0,{config:e,next:r};try{const r=await async function(e,t){const{uuid:r,ignoreCache:a}=e,n=await e.store.getItem(r);if(a||!n||!n.data){e.debug("cache-miss",t.url);const r=new Error;throw r.reason="cache-miss",r.message="Entry not found from cache",r}const{expires:c,data:o}=n;if(("undefined"==typeof navigator||!("onLine"in navigator)||navigator.onLine)&&!e.acceptStale&&0!==c&&c<Date.now()){e.debug("cache-stale",t.url);const r=new Error;throw r.reason="cache-stale",r.message="Entry is stale",r}return e.debug(e.acceptStale?"cache-hit-stale":"cache-hit",t.url),o}(e,t);return r.config=t,r.request={fromCache:!0},{config:e,next:r}}catch(t){return e.clearOnStale&&"cache-stale"===t.reason&&await e.store.removeItem(e.uuid),{config:e,next:r}}}t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r;class h{constructor(){this.store={}}async getItem(e){const t=this.store[e]||null;return JSON.parse(t)}async setItem(e,t){return this.store[e]=JSON.stringify(t),t}async removeItem(e){delete this.store[e]}async clear(){this.store={}}async length(){return Object.keys(this.store).length}iterate(e){return Promise.all(function(e,t){return n(e)?Object.keys(e).map((r=>t(e[r],r))):[]}(this.store,e))}}const p=()=>{},m=(...e)=>console.log("[axios-cache-adapter]",...e),y={maxAge:0,limit:!1,store:null,key:null,invalidate:null,exclude:{paths:[],query:!0,filter:null,methods:["post","patch","put","delete"]},clearOnStale:!0,clearOnError:!0,readOnError:!1,readHeaders:!1,debug:!1,ignoreCache:!1,adapter:async(e,r)=>{const{method:a,url:n,...c}=r,{baseURL:o}=e;return t.create({...c,baseURL:o,adapter:t.defaults.adapter})[a](n)}},g={cache:{maxAge:9e5}},b=["limit","store","adapter","uuid","acceptStale"],x=function(e={}){const t={...y,...e,exclude:{...y.exclude,...e.exclude}};return t.key=u(t),t.invalidate=function(e={}){return o(e.invalidate)?e.invalidate:i}(t),!1!==t.debug?t.debug="function"==typeof t.debug?t.debug:m:t.debug=p,t.store||(t.store=new h),t.debug("Global cache config",t),t};function w(e={}){return{adapter:async function(t){const r=function(e,t){const r=t.cache||{};r&&b.forEach((e=>r[e]?delete r[e]:void 0));const a={...e,...r,exclude:{...e.exclude,...r.exclude}};return!0===a.debug&&(a.debug=m),r.key&&(a.key=u(r)),a.uuid=a.key(t),e.debug(`Request config for ${t.url}`,a),a}(e,t);let a=await f(r,t);const n=a.next;if(!o(n))return{...n,cached:!0};let c;try{a=await r.adapter(r,t),a.cached=!1}catch(e){c=e}if(c){if(o(r.readOnError)?r.readOnError(c,t):r.readOnError)try{return r.acceptStale=!0,a=await f(r,t),a.next.request.stale=!0,a.next}catch(e){}throw c}return n(a)},config:e=x(e),store:e.store}}e.serializeQuery=d,e.setup=function(e={}){const r={...g,...e,cache:{...g.cache,...e.cache}},a=w(r.cache),{cache:n,...c}=r,o=t.create({...c,adapter:a.adapter});return o.cache=a.store,o},e.setupCache=w,Object.defineProperty(e,"__esModule",{value:!0})}));